<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Female Reproductive System</title>
    <script src="libraries/babylon.js"></script>
    <script src="libraries/babylonjs.loaders.min.js"></script>
    <script src="https://cdn.babylonjs.com/gui/babylon.gui.min.js"></script>
    <style>
        #contentHolder{
            -webkit-user-select: none; /* Safari */
            -ms-user-select: none; /* IE 10 and IE 11 */
            user-select: none; /* Standard syntax */
            font-family: Arial, Helvetica, sans-serif;
            left: 3%;
            right: 3%;
            position: absolute; 
            border-radius: 25px;
            background: #000000; /*this colour will be set via JS*/
            overflow:hidden;
        }
        #renderCanvas {
            outline: none;
            -webkit-tap-highlight-color: rgba(255, 255, 255, 0); /* mobile webkit */
            width: 66%;
            height: 100%; 
            float:left;
            display:inline-block;
        }
        #infoDiv {
            font-size: 1.5vw;
            width: 30%;
            padding-right: 3%;
            float:right;
            display:inline-block;
            color: #f6fafa;
        }
    </style>
</head>
<body>
    <div id="contentHolder">
        <canvas id="renderCanvas"></canvas>
        <div id="infoDiv">
            <h3>Lorem ipsum</h3>
            <p>Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat. <br><br>
            Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. </p>
        </div>
    </div>
    <script>
        //App configuration:
        let debugMode = true;
        let backgroundColour = "#183447"; //Change background colour here!
        let contentScale = 0.2;
        
        let enablePanning = false;
        let panningSpeed = 1000; //bigger number - slower panning! 1000 default
        //let enableRotation = false; - implement later
        //let rotationSpeed = ?? - implement later
        // let rotationLimits = ?? - implement later
        
        //let enableZoom = false; - implement later
        let minCamZoom = 2;
        let camStartZoom = 3;
        let maxCamZoom = 5;
        
        //Animations:
        let fadeInLerpSpeed = 0.05;
        let fadeOutLerpSpeed = 0.2;
        
        //Hotspots configuration:
        let hotspotConfig = 
        [[new BABYLON.Vector3(-0.1, -1.0, 0.2), "Vagina, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. ", ""],
         [new BABYLON.Vector3(-0.3, -0.3, 0.5), "Cervix, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. ", "assets/2D/heart/temp2.jpg"],
         [new BABYLON.Vector3(-0.08,0.1,0.5), "Ovary, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. ", "assets/2D/heart/temp3.jpg"]
		 [new BABYLON.Vector3(-0.08,0.1,0.5), "Fallopian Tube, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. ", "assets/2D/heart/temp3.jpg"]
		 [new BABYLON.Vector3(-0.08,0.1,0.5), "Uterus, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. ", "assets/2D/heart/temp3.jpg"]
		 [new BABYLON.Vector3(-0.08,0.1,0.5), "Fundus, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. ", "assets/2D/heart/temp3.jpg"]
		 [new BABYLON.Vector3(-0.08,0.1,0.5), "Fimbriae, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. ", "assets/2D/heart/temp3.jpg"]];
        
        //Set background colour:
        document.getElementById("contentHolder").style.background = backgroundColour;
        
        //Babylonjs:
        window.addEventListener('DOMContentLoaded', function () {
            var canvas = document.getElementById('renderCanvas');
            var engine = new BABYLON.Engine(canvas, true);
            var scene = new BABYLON.Scene(engine);
            var gui = BABYLON.GUI.AdvancedDynamicTexture.CreateFullscreenUI("UI");
            gui.idealWidth = 600;
            scene.clearColor = BABYLON.Color3.FromHexString(backgroundColour);
            if(debugMode) scene.debugLayer.show();

            var camera = new BABYLON.ArcRotateCamera("Camera", 0, 0, 10, new BABYLON.Vector3(0, 0, 0), scene);
            
            camera.lowerRadiusLimit = minCamZoom;
            camera.upperRadiusLimit = maxCamZoom;
            camera.viewport = new BABYLON.Viewport(-0.15,0,1,1);
            camera.setPosition(new BABYLON.Vector3(0, 0, camStartZoom));
            camera.attachControl(canvas, false);
            camera.panningSensibility = (panningSpeed * (enablePanning ? 1:0));

            var light = new BABYLON.HemisphericLight('light', new BABYLON.Vector3(0, 1, 0), scene);
           
            LoadModel();
            
            //Model Loading:
            function LoadModel()
            {
                BABYLON.SceneLoader.ImportMeshAsync("", "assets/3D/", "FemaleReproductiveSystem.glb").then(function (result) {
                    var model = result.meshes[0]; // Assuming the model is the first mesh in the imported result
                    model.scaling = new BABYLON.Vector3(contentScale, contentScale, contentScale);
					
					// Nick messing to repositioon model
					model.position = new BABYLON.Vector3(0,-2,0);
                    
                    SetGUI();
                    
                    for(let i = 0; i < hotspotConfig.length; i++)
                    {
                        SetHotspot(i, hotspotConfig[i][0], hotspotConfig[i][1], hotspotConfig[i][2]);
                    }
                    
                    let currentAlpha = 0;
                    let targetAlpha = 0;
                    
                    scene.onBeforeRenderObservable.add(() => {
                        targetAlpha = isGuiVisible ? 1 : 0;
                        currentAlpha = BABYLON.Scalar.Lerp(currentAlpha, targetAlpha, (isGuiVisible? fadeInLerpSpeed : fadeOutLerpSpeed))
                        
                            //linkerLine.parent.alpha = isGuiVisible ? 1 : 0;
                            linkerLine.alpha = currentAlpha;
                            circleGUI.alpha = currentAlpha;
                            circleGUITop.alpha = currentAlpha;
                            uiLine.alpha = currentAlpha;
                            rectGUI.alpha = currentAlpha;
                        });
                    
                });
            }
            
            var isGuiVisible = false;
            let lastGuiVisibleChangeTime;
            
            var linkerLine = new BABYLON.GUI.Line("LinkerLine"); //This is a line that connects the GUI with the hotspot(on hotspot selection)
            var uiLine = new BABYLON.GUI.Line("UILine");
            var circleGUI;// = new BABYLON.GUI.Ellipse("CircleGUI");
            var circleGUIimage = new BABYLON.GUI.Image("CircleGUImage");
            var circleGUITop = new BABYLON.GUI.Ellipse("CircleGUICircle");
            var rectGUIText = new BABYLON.GUI.TextBlock("RectGUIText");
            var rectGUI = new BABYLON.GUI.Rectangle();
           
            
            function SetGUI()
            {
                // Create circle GUI for image:
                circleGUI = new BABYLON.GUI.Ellipse("CircleGUI");
                circleGUI.left = "35%";
                circleGUI.top = "-25%";
                circleGUI.width = "110px";
                circleGUI.height = "110px";
                circleGUI.color = "White";
                circleGUIimage = new BABYLON.GUI.Image("image", "assets/2D/heart/temp1.jpg")
                circleGUI.addControl(circleGUIimage)
                gui.addControl(circleGUI);
                 
                //Configure linker line (the line that connects GUI to 3D hotspot)
                linkerLine.lineWidth = 4;
                linkerLine.color = "White";
                linkerLine.x2 = -54;
                gui.addControl(linkerLine);
                linkerLine.connectedControl = circleGUI;
                
                //Configure rest of GUI
                rectGUI.width = "30%";//"100px";
                rectGUI.height = "30%";//"60px";
                //rect.color = "Orange";
                rectGUI.thickness = 0;
                rectGUI.background = "rgb(150,195,106)";
                rectGUI.cornerRadius = 10;
                rectGUI.left = "35%";//"182px"; // Adjust as needed
                rectGUI.top = "60px"; // Adjust as needed
                gui.addControl(rectGUI);
                //rect.isVisible = false; // Initially hidden
 
                rectGUIText.textWrapping = true;
                //text1.widthInPixels = 300;

                rectGUIText.resizeToFit = true;
                rectGUIText.lineSpacing = 1;
                //text1.width("200);
                rectGUIText.textHorizontalAlignment = 0;
                //text1.horizontalAlignment = 0;
                rectGUIText.left = 3;
                rectGUIText.width = "80%";
                rectGUIText.color = "#fff"
                rectGUIText.fontSize = 10;
                
                rectGUIText.text = "No hotspot";
                rectGUI.addControl(rectGUIText);
                 
                uiLine.lineWidth = 4;
                uiLine.color = "White";
                uiLine.x1 = 511;
                uiLine.y1 = 165;
                uiLine.x2 = 1;
                uiLine.y2 = 54;
                gui.addControl(uiLine);
                uiLine.connectedControl = circleGUI;
            }
            
            function SetHotspot(_index, _pos, _text, _image){
                
                const helperSphere = BABYLON.MeshBuilder.CreateSphere(
                    "hotspotSphere" ,
                    {},
                    this.scene
                );
                
                helperSphere.scaling = new BABYLON.Vector3(0.1, 0.1, 0.1);
                helperSphere.position = _pos;
                helperSphere.visibility = 0.001;
                helperSphere.occlusionType = BABYLON.AbstractMesh.OCCLUSION_TYPE_OPTIMISTIC;
                
                var target = new BABYLON.GUI.Ellipse();
                var startSize = "10px";
                var hoverSize = "15px";
                target.width = "10px";
                target.height = "10px";
                target.color = "rgb(150,195,106)";
                target.thickness = 3;
                target.background = "white";
                gui.addControl(target);
                target.linkWithMesh(helperSphere);

                target.onPointerEnterObservable.add(() => {
                    target.width = hoverSize;
                    target.height = hoverSize;
                })
                target.onPointerOutObservable.add(() => {
                    target.width = startSize;
                    target.height = startSize;
                })

                
                
                //Make hotspot disappear if it's behind the model:
                scene.onBeforeRenderObservable.add(() => {
                    target.alpha =helperSphere.isOccluded? 0:1;
                    //console.log(helperSphere.isOccluded);
                    });
                
                //On Click Event:
                target.onPointerDownObservable.add(function () {
                    OnHotspotInteraction(_index, helperSphere, _text, _image);
                });
            }
            
            function OnHotspotInteraction(_index, _model, _text, _image)
            {
                console.log("Interacted with hotspot " + _index);
                linkerLine.linkWithMesh(_model);
                circleGUIimage.dispose();
                circleGUIimage = new BABYLON.GUI.Image("image", _image)
                circleGUI.addControl(circleGUIimage)
                
                circleGUITop.dispose();
                circleGUITop = new BABYLON.GUI.Ellipse("CircleGUICircle");
                circleGUITop.width = "110px";
                circleGUITop.height = "110px";
                circleGUITop.color = "White";
                circleGUITop.thickness = 4;
                
                circleGUI.addControl(circleGUITop);
                
                rectGUIText.text = _text;
                lastGuiVisibleChangeTime = Date.now();
                isGuiVisible = true;
            }
            
            scene.onPointerObservable.add((pointerInfo) => {
                   switch (pointerInfo.type) {
                       case BABYLON.PointerEventTypes.POINTERDOWN:
                          let timeNow = Date.now();
                           if(timeNow > (lastGuiVisibleChangeTime + 100))
                           {
                               isGuiVisible = false;
                               lastGuiVisibleChangeTime = timeNow;
                           }
                           break;
                   }
               });
            
            engine.runRenderLoop(function () {
                scene.render();
            });
            
            window.addEventListener('resize', function () {
                engine.resize();
            });
        });
    </script>
</body>
</html>
